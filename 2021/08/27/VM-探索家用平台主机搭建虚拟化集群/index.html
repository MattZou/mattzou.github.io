<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="https://mattblog.oss-cn-beijing.aliyuncs.com/img/ico/favicon.jpg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="description" content="虚拟化小探索"><meta name="author" content="MattZou"><meta name="keywords" content=""><title>家用平台主机搭建虚拟化集群 - Matt</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/themes/prism-okaidia.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"mattzou.com",root:"/",version:"1.8.9a",typing:{enable:!0,typeSpeed:50,cursorChar:"|",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong><img style="margin-top:-.2em;width:15%" src="https://mattblog.oss-cn-beijing.aliyuncs.com/img/ico/favicon.jpg" srcset="/img/loading.gif" lazyload> MattZou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/bb/"><i class="iconfont icon-speakernotes"></i> 想法</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(https://mattblog.oss-cn-beijing.aliyuncs.com/img/index_img/kvm-01.png/bg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="家用平台主机搭建虚拟化集群"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-08-27 00:00" pubdate>2021年8月27日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 113 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">家用平台主机搭建虚拟化集群</h1><div class="markdown-body"><h1 id="探坑"><a href="#探坑" class="headerlink" title="探坑"></a>探坑</h1><p>最近购置了三台办公用主机，既要兼顾<code>Windows</code>平台下办公需求，又要考虑开发<code>Linux</code>集群部署，物理机-&gt;虚拟化-&gt;容器这样的架构从维护和拓展性上都是最佳的选择，虚拟化是一切服务的基础，因此需要找到一个合适的虚拟化方案。</p><p>找了一圈，开源，主流，易上手的虚拟化方案主要有两种：物理机<code>Win</code>环境，用<code>wsl</code>或者<code>VirtualBox</code>跑<code>CentOS</code>；另一种是物理机<code>CentOS</code>，用<code>KVM</code>虚拟<code>Win</code>以及<code>Linux</code>。前一种方案，在单机上尝试过，<code>wsl/wsl2</code>各有优劣，一切看微软大爷眼色行事，更加适用于个人或小组研究，扩展性上估计一堆坑，所以绕过，考虑在<code>Linux</code>下用<code>KVM</code>的<a target="_blank" rel="noopener" href="https://www.redhat.com/zh/topics/virtualization/what-is-KVM">解决方案</a>。</p><p>单机上架设多个VM，使用<code>virt-manager</code>可以很方便进行管理，对于集群<code>KVM</code>管理，常用的是<code>Proxmox</code>和<code>WebVirtMgr</code>，都比较容易上手。但看着<code>Proxmox</code>官网更加炫酷，安装方便，集群维护、VM迁移等功能齐备，而且网上保姆教程一大堆，用<code>Ventory</code>还能自动部署，就选它了。</p><hr><blockquote><p>以上都是动手前的美好设想。</p></blockquote><h1 id="掉坑"><a href="#掉坑" class="headerlink" title="掉坑"></a>掉坑</h1><h2 id="硬件配置"><a href="#硬件配置" class="headerlink" title="硬件配置"></a>硬件配置</h2><p>三台配置相同，如下表所示。</p><table><thead><tr><th align="center">Part</th><th align="center">Model</th></tr></thead><tbody><tr><td align="center">CPU</td><td align="center">Tiger Lake i7-11700 8c16t 2.5-4.9GHz</td></tr><tr><td align="center">GPU</td><td align="center">Intel® UHD Graphics 750</td></tr><tr><td align="center">Memory</td><td align="center">16*2 3600MHz</td></tr><tr><td align="center">Motherboard</td><td align="center">B560m</td></tr><tr><td align="center">Ethernet</td><td align="center">RTL8125B</td></tr><tr><td align="center">SSD</td><td align="center">M.2 500g</td></tr><tr><td align="center">HDD</td><td align="center">5400RPM 2T</td></tr></tbody></table><p>装机就开始坑了，CPU风扇方向装反，拆了装装了拆===好歹是开机亮灯没问题。先装了个Win做稳定性测试，FS140风冷压不带k的i7还是没问题，不过反复拆装可能导致一个硅脂没涂好，两台双烤差了5℃，我都怕没撕膜直接怼上了。B560主板支持内存超频，镁光C9BJZ颗粒XMP上3600<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/369653535">轻松容易</a>，就是3600再往上，<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1AM4y157ut">内存分频</a>代价太大，就不折腾了。</p><h2 id="Proxmox安装"><a href="#Proxmox安装" class="headerlink" title="Proxmox安装"></a>Proxmox安装</h2><p>Proxmox VE最新7.0版本是基于Debian 11，安装方式提供iso直装，批量部署推荐使用Ventory（真是装机神器，iso一放，脚本一配置就可以喝茶去了）。</p><p>但是，在这个家用机平台，安装出问题了😭。</p><p>7.0镜像启动，进入Boot选择，自检过后，在Debian中走到<br><code>starting a root shell on tty3</code>时候直接卡住，两眼一抹黑，连左上角卡住光标的机会都没有===</p><p>找各种资料后，发现也有这个新平台（z590 + 11700）出<a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/stuck-on-root-shell-on-tty3.86956/">问题</a>，尝试里面的解决方法</p><h3 id="修改xorg配置"><a href="#修改xorg配置" class="headerlink" title="修改xorg配置"></a>修改xorg配置</h3><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ chmod 1777 &#x2F;tmp  
$ apt update
$ apt upgrade
$ Xorg -configure  
$ mv &#x2F;xorg.conf.new &#x2F;etc&#x2F;X11&#x2F;xorg.conf
$ vim &#x2F;etc&#x2F;X11&#x2F;xorg.conf # update Driver &quot;amdgpu&quot;-&gt; &quot;fbdev&quot; &lt;-be sure to get all instances in the case of a multi-head card which tripped me up initially.
$ startx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>一番折腾后总算看到安装界面，但是上面只有几个大字<br><strong><code>No Network Interface Found</code></strong><br>事情变得微妙起来，新平台出问题，大概率是驱动跟不上。既然是网络问题，于是带上网卡关键词<a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/no-network-interface-found-for-rtl8125b.72378/">No Network Interface Found for RTL8125B</a>，思路豁然开朗。<br>其中有人通过一个复杂的网卡驱动安装解决了。</p><h3 id="安装网卡驱动"><a href="#安装网卡驱动" class="headerlink" title="安装网卡驱动"></a>安装网卡驱动</h3><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">1) 1 usb with proxmox, 1 usb with driver package
2) Boot into proxmox installer and Select debug mode installation
3)Press ctrl+d once for it to proceed
4)plug in android phone after enabling usb tether on the phone
5)type in ‘ ip addr show ‘ And note down the interface name for the usb tether, mine was enp0s something something
6) type in ‘ ip link set enp0s up’ #replace enp0s with your own interface name
7) type in dhclient enp0s #replace enp0s with your own interface name
8) test connectivity by using ping, ‘ping 1.1.1.1’
9) &#39;apt update&#39;
10)install pve-header apt install pve-headers-$(uname -r)
11) cd into a directory to make the second usb mount&#x3D; &#39;cd &#x2F;media&#39;
12) ‘mkdir usb’
13) use blkid to find the correct &#x2F;dev&#x2F;sd** name for your usb, (mine was sda1)
14) ‘mount &#x2F;dev&#x2F;sda1 &#x2F;media&#x2F;usb&#x2F;‘
15) cd &#x2F;media&#x2F;usb
16)’ls’ #to find names
17) my tmp folder was restricted and apt couldn&#39;t use it, i had to &#39;chmod 1777 &#x2F;tmp&#39; to make it open again
18) &#39;apt install build-essential&#39;
19) extract r8125-9.003.05.tar if not already done so, &#39;tar -xvf r8125-9.003.05.tar&#39;
20) cd into r8125-9.003.05 folder and execute the script autorun.sh&#x3D; &#39;chmod +x autorun.sh&#39; and &#39;.&#x2F;autorun.sh&#39;
21) now you can unplug the usb tether, repeat steps 5-8 to check if your Ethernet connection works.
22) now you can do what they ask the ctrl+D again(?) to go back into normal mode and it&#39;ll find your network interface and you can proceed normally.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>其实驱动问题大部分还是kernel问题，查阅发现<code>Linux kernel</code>对<code>RTL8125B</code>网卡支持在<a target="_blank" rel="noopener" href="https://linuxreviews.org/Realtek_RTL_8125">5.9</a>就已经实现了啊。Debian 11咋也是这之上了，无解。</p><p>可能点背，上面那一串步骤执行了，还是没反应。（这个后面再试试，估计是那天太累了🤣）</p><p>然后发现一堆人用着这个网卡，Proxmox还是6.4的都搞定了，他们做的就是升级内核到5.11。<a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/realtek-rtl-8125b.86747/">[SOLVED] Realtek RTL 8125B</a></p><p>当然，终极大杀器就是<a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_Buster">Install Proxmox VE on Debian Buster</a></p><h3 id="先安装Debian再装Proxmox"><a href="#先安装Debian再装Proxmox" class="headerlink" title="先安装Debian再装Proxmox"></a>先安装Debian再装Proxmox</h3><p>这个后面有空再折腾，估计又是一堆内核，驱动升级。<br>好在GitHub上有人放出来了基于Debian发行版的<a target="_blank" rel="noopener" href="https://github.com/tubaxiaosiji/RTL8125-Driver-for-Proxmox-VE5-6-and-debian">解决方案</a>，后面有机会抄作业。</p><h1 id="爬坑"><a href="#爬坑" class="headerlink" title="爬坑"></a>爬坑</h1><p>折腾了好久还没成效，本着退一步海阔天空🌏的想法，暂时放弃Proxmox🤷‍♂️，就先装CentOS用着，后面Proxmox折腾明白了再做单机VM向集群迁移也行。</p><p>在团队大佬的点醒下，退化到中级玩法（定义来自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/49118355">此文</a>）试试👨‍🚀。</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">那么 KVM + Libvirtd 有几种不同层次的玩法：

初级：在 &#x2F;etc&#x2F;libvirtd&#x2F;qemu 下面用 xml 描述每一台虚拟机的配置，
    然后用 virsh 在命令行管理虚拟机，
    最后用 VNC&#x2F;SPICE 按照配置好的端口链接过去，模拟终端操作。
中级：使用各种 libvirtd 的前端，比如基于桌面 GUI 的 Virt Manager 给你界面上直接编辑和管理虚拟机，
    桌面版本的 VNC&#x2F;SPICE 会自动弹出来，像 VmWare 一样操作。
高级：使用基于 Web 的各种 virt manager 进行集群管理，
    比如轻量级的 WebVirtMgr &#x2F; Kimchi，
    适合小白的 Proxmox VE。基本是用 WebVnc&#x2F;Web
超级：上重量级的 OpenStack，
    搭配自己基于 libvirt （libvirtd 的客户端库，比如有 python-libvirt 的封装）写的各种自动化脚本。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="CentOS-KVM配置"><a href="#CentOS-KVM配置" class="headerlink" title="CentOS KVM配置"></a>CentOS KVM配置</h2><p>实验在CentOS中配置一台WinServer虚拟机。<br>首先在BIOS中打开虚拟化。</p><h3 id="安装必要包"><a href="#安装必要包" class="headerlink" title="安装必要包"></a>安装必要包</h3><p>CentOS8中自带了QEMU/KVM支持<br>参考<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="How to Install KVM on CentOS 8
">[1]</span></a></sup><sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="How to Install KVM on CentOS/RHEL 8
">[2]</span></a></sup></p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">yum groupinstall &quot;Virtualization Host&quot;
sudo systemctl enable --now libvirtd
sudo yum -y install virt-top libguestfs-tools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><p>可以选择以两种直观的可视化界面进行配置。</p><p>GUI管理工具</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sudo yum -y install virt-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>Cockpit Web Console管理工具</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">dnf install cockpit cockpit-machines
systemctl start cockpit.socket
systemctl enable cockpit.socket
systemctl status cockpit.socket
firewall-cmd --add-service&#x3D;cockpit --permanent
firewall-cmd --reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="配置桥接网络"><a href="#配置桥接网络" class="headerlink" title="配置桥接网络"></a>配置桥接网络</h3><p>为了方便虚拟机外网连通访问，需要架设网桥。此处需要物理网口支持，Wifi网卡配置存在问题。<br>关于Bridge和NAT模式区别，可参考<a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch06.html#networkingmodes">Virtual Networking</a>和<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ed0ce43374e6">网络配置Bridge方式、NAT方式</a></p><p>CentOS8 使用nmcli命令进行网络配置</p><ol><li><p>查看当前连接</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli connection<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>记录ethernet的device 标识</p></li><li><p>新建名为br0的网桥</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli connection add type bridge con-name br0 ifname br0 autoconnect yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p>编辑网桥，设置静态IP及网关</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli conn modify br0 ipv4.addresses &#39;192.168.0.x&#x2F;24&#39;
nmcli conn modify br0 ipv4.gateway &#39;192.168.0.1&#39;
nmcli conn modify br0 ipv4.dns &#39;192.168.0.1&#39;
nmcli conn modify br0 ipv4.method manual<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div><p>或者编辑文件</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-br0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>修改</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">IPADDR&#x3D;192.168.0.x
PREFIX&#x3D;24
GATEWAY&#x3D;192.168.0.1
DNS1&#x3D;192.168.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>网桥连接至物理网卡<br>假设物理网卡 device 标识为 enp3s0</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli connection add type bridge-slave ifname enp3s0 master br0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p>启动网桥</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli connection up br0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p>关闭物理网卡</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">nmcli connection down enp3s0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>再次查看连接状态，或者ping一下百度🫓，确认联网成功。</p></li></ol><h3 id="Windows镜像安装"><a href="#Windows镜像安装" class="headerlink" title="Windows镜像安装"></a>Windows镜像安装</h3><p>合理合法获取ISO文件👮🚔。</p><p>使用之前安装的<code>virt-manager</code>工具<br><img src="https://phoenixnap.com/kb/wp-content/uploads/2021/04/2020-11-03_13-19-09.png" srcset="/img/loading.gif" lazyload><br>或者通过<code>Cockpit</code>安装。<br><img src="https://www.tecmint.com/wp-content/uploads/2020/03/Create-New-Virtual-Machine.png" srcset="/img/loading.gif" lazyload></p><p>详细配置参考<a target="_blank" rel="noopener" href="https://getlabsdone.com/install-windows-server-on-kvm/">10 Easy Steps To Install Windows Server in Linux KVM</a>，文章步骤极为清晰。要注意的地方有三个：</p><ol><li><p>CPU设置，一定要指定拓扑结构，设置不当会影响性能<a target="_blank" rel="noopener" href="https://getlabsdone.com/install-windows-server-on-kvm/#Configure-the-CPU-for-the-KVM-windows-guest">Configure the CPU for the KVM windows guest properly.</a>。关于这些参数如何设置，可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/GyForever1004/p/13600183.html">【进程调度】关于CPU的sockets、dies、cores、threads含义理解</a>。</p></li><li><p>硬盘一定选择VirtIO形式，比SATA性能更好，甚至接近物理机水平<a target="_blank" rel="noopener" href="https://getlabsdone.com/install-windows-server-on-kvm/#No-windows-harddisk-in-kvm">No windows harddisk in KVM ?, fix that now.</a>；此处注意的原因是，一旦用SATA模式安装后，再切换回VirtIO模式，Windows会显示<code>INACCESSIBLE_BOOT_DEVICE</code>并BSOD，后续切换会很费劲。</p></li><li><p>VirtIO驱动很重要，不能遗漏下载。</p></li></ol><h3 id="物理机迁移到KVM"><a href="#物理机迁移到KVM" class="headerlink" title="物理机迁移到KVM"></a>物理机迁移到KVM</h3><p>安装好虚拟机之后，需要把原先物理机上的系统原封搬过来。我使用<a target="_blank" rel="noopener" href="https://www.disktool.cn/backup/backup-software.html">傲梅轻松备份</a>工具</p><ol><li>在原机器上进行系统备份，将备份导入移动硬盘</li><li>在工具里创建PE，选择Windows版，创建过程这会打包VirtIO驱动，生成的ampe.iso通过scp传输到宿主机上</li><li>关闭虚拟机，添加硬件，挂载备份硬盘，ampe.iso，VirtIO驱动iso。设置ampe.iso为启动项</li><li>进入恢复程序，选择备份，进行全盘恢复</li><li>重启虚拟机，卸除挂载，设置主硬盘为引导项</li><li>设置宿主机引导时，虚拟机同步启动</li></ol><h3 id="KVM迁移"><a href="#KVM迁移" class="headerlink" title="KVM迁移"></a>KVM迁移</h3><p>将物理机迁移到KVM上之后，KVM也提供不同物理机之间的VM迁移，相当于集群间虚拟机移动，KVM迁移有冷热两种。由于热迁移需要设置NFS共享盘，还没做测试，目前通过冷迁移完成了一个虚拟机的移动。<br>首先确保目标宿主机配置好了KVM环境和网络。</p><h4 id="冷迁移"><a href="#冷迁移" class="headerlink" title="冷迁移"></a>冷迁移</h4><p>关机</p><ol><li>通过scp把虚拟机所有qcow2镜像文件传输到目标宿主机</li><li>把此机器配置xml文件传输到目标，文件位置在<code>/etc/libvirt/qemu/</code><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">scp -rp &#x2F;data&#x2F;win01.qcow2 root@172.168.0.x:&#x2F;data
scp -rp &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;cwin01.xml root@172.168.0.x:&#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></li><li>目标宿主机切换到xml配置目录<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">virsh define win01.xml 
virsh list --all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>可以看到虚拟机已经注册<br>此时启动虚拟机，可能会遇到<a target="_blank" rel="noopener" href="https://www.pianshen.com/article/65991564217/">KVM上创建虚拟机和权限有关的故障</a>。<br>建议在启动前，配置qcow2存放目录权限<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">chown qemu:qemu &#x2F;data<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><h4 id="热迁移"><a href="#热迁移" class="headerlink" title="热迁移"></a>热迁移</h4>暂未做测试，留坑。参考<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="KVM虚拟机迁移（冷迁移、热迁移）
">[3]</span></a></sup></li></ol><h3 id="KVM性能优化"><a href="#KVM性能优化" class="headerlink" title="KVM性能优化"></a>KVM性能优化</h3><ol><li>存储主要是磁盘模式（VirtIO）</li><li>CPU：CPU较新的型号KVM里没有提供对应模板，因此在cpu型号设置中手动输入<code>host-passthrough</code>可以向VM公开主机CPU的全部功能，默认设置下11700处理在虚拟机中<code>cpuz</code>自动识别为10代服务器处理器，且锁定频率为基频。设置直通后，可以识别为正确型号，且睿频生效<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="在virt-manager中使用CPU型号主机直通
">[4]</span></a></sup>。</li><li>显示性能，由于11代处理器集成显卡有较大升级，后期准备研究一下<code>Intel GVT-g</code>显卡直通技术，提升虚拟机显示性能，视频可以看起来了📺</li><li>显示模式：目前采用QXL模式，默认16M显存，在配置xml中改造为128M，重载配置生效，由于手头都是1080p显示器，不知道是否真能支持4K<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="qemu+spice的QXL配置
">[5]</span></a></sup>。</li></ol><h2 id="WebVirtCloud管理KVM"><a href="#WebVirtCloud管理KVM" class="headerlink" title="WebVirtCloud管理KVM"></a>WebVirtCloud管理KVM</h2><p><a target="_blank" rel="noopener" href="http://retspen.github.io/">WebVirtMgr</a>是之前很很火的的KVM虚拟化Web管理工具，但GitHub上年久失修，并且逐渐迁移到WebVirtCloud，因此考虑部署WebVirtCloud管理服务器用来对集群虚拟机进行集中管理。</p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a target="_blank" rel="noopener" href="https://github.com/retspen/webvirtcloud">WebVirtCloud</a>基于Python 3.x &amp; Django 3.2 LTS构建。</p><p>特性包括：</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">QEMU&#x2F;KVM Hypervisor Management
QEMU&#x2F;KVM Instance Management - Create, Delete, Update
Hypervisor &amp; Instance web based stats
Manage Multiple QEMU&#x2F;KVM Hypervisor
Manage Hypervisor Datastore pools
Manage Hypervisor Networks
Instance Console Access with Browsers
Libvirt API based web management UI
User Based Authorization and Authentication
User can add SSH public key to root in Instance (Tested only Ubuntu)
User can change root password in Instance (Tested only Ubuntu)
Supports cloud-init datasource interface<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="创建WebVirtCloud服务器"><a href="#创建WebVirtCloud服务器" class="headerlink" title="创建WebVirtCloud服务器"></a>创建WebVirtCloud服务器</h4><p>由于WebVirtCloud需要配置默认Nginx配置，且没有提供Docker部署方式，因此考虑单开一台虚拟机作为管理服务器。创建CentOS8-GUI虚拟机一台。选择GUI版，并附加安装虚拟机组件，一些WebVirtCloud的依赖包附带安装了，配置的时候比较省事。</p><h4 id="WebVirtCloud快速安装模式"><a href="#WebVirtCloud快速安装模式" class="headerlink" title="WebVirtCloud快速安装模式"></a>WebVirtCloud快速安装模式</h4><ol><li>进入快速安装<br>网好<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;retspen&#x2F;webvirtcloud&#x2F;master&#x2F;install.sh
chmod 744 install.sh
# run with sudo or root user
.&#x2F;install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>网不好，<a target="_blank" rel="noopener" href="https://github.com/retspen/webvirtcloud/archive/refs/heads/master.zip">下载</a>包，解压，然后<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">chmod 744 install.sh
# run with sudo or root user
.&#x2F;install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></li><li>快速安装模式里配置端口，建议默认，后期可以配置端口转发<sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="Install WebVirtCloud KVM Management on CentOS 8 / Stream 8
">[6]</span></a></sup>。<br>以下是默认配置和需要确认的部分<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">WEBVIRTCLOUD

  Welcome to Webvirtcloud Installer for CentOS, Fedora, Debian and Ubuntu!

  The installer has detected centos version 8.
  Q. Do you want to configure fqdn for Nginx? (y&#x2F;n) y

  Q. What is the FQDN of your server? (&#123;serverip_or_hostname&#125;):
     Setting to &#123;serverip_or_hostname&#125;

  Q. Do you want to change NOVNC service port number?(Default: 6080)
     Setting novnc service port 6080

  Q. Do you want to change NOVNC public port number for reverse proxy(e.g: 80 or 443)?(Default: 6080)
      Setting novnc public port 6080

  Q. Do you want to change NOVNC host listen ip?(Default: 0.0.0.0)
      Setting novnc host ip 0.0.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>确认后会自动执行安装，如果没有错误，会出现<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">***Open http:&#x2F;&#x2F;&#123;hostname&#125; to login to webvirtcloud.***

* Cleaning up...
* Finished!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></li></ol><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="添加Webvirtcloud服务器对KVM宿主机的ssh访问"><a href="#添加Webvirtcloud服务器对KVM宿主机的ssh访问" class="headerlink" title="添加Webvirtcloud服务器对KVM宿主机的ssh访问"></a>添加Webvirtcloud服务器对KVM宿主机的ssh访问</h4><ol><li>在Webvirtcloud服务器端，生成ssh key<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sudo -u nginx ssh-keygen
ls -lh &#x2F;var&#x2F;lib&#x2F;nginx&#x2F;.ssh&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></li><li>传输到KVM宿主机<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sudo -u nginx ssh-copy-id root@compute1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li>测试nginx用户对KVM宿主机的访问连接<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">virsh --connect qemu+ssh:&#x2F;&#x2F;root@compute1&#x2F;system list --all<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>如果可以看到虚拟机列表，则表明配置成功。<br>每次新增KVM宿主机节点，按以上步骤实现一遍即可。</li></ol><h4 id="访问Web-Dashboard"><a href="#访问Web-Dashboard" class="headerlink" title="访问Web Dashboard"></a>访问Web Dashboard</h4><p>在http://{serverip_or_hostname}可进入管理登录页面，默认admin/admin。进入后可以修改密码等配置。</p><p>在计算节点（Computer）面板，添加ssh连接到宿主机。FQDN/IP,Login等项目按照刚才配置的ssh访问项目填写即可。<br><img src="https://mattblog.oss-cn-beijing.aliyuncs.com/img/IT/KVM/hosts.png" srcset="/img/loading.gif" lazyload><br>添加后状态显示成功即可，返回实例（Instance）面板对宿主机下挂虚拟机进行管理。<br><img src="https://mattblog.oss-cn-beijing.aliyuncs.com/img/IT/KVM/grouped.png" srcset="/img/loading.gif" lazyload><br>实例详情<br><img src="https://mattblog.oss-cn-beijing.aliyuncs.com/img/IT/KVM/instance.png" srcset="/img/loading.gif" lazyload></p><h2 id="内网穿透Frp"><a href="#内网穿透Frp" class="headerlink" title="内网穿透Frp"></a>内网穿透Frp</h2><p>服务器配置好，外网如果要访问，且没有固定IP（其实是💴不够），需要内网穿透方案。应急可以使用花生壳的免费版，但流量速度有限。刚好有台阿里云ECS，可以作为跳板，进行内网穿透。<br>选用Frp方案进行配置。</p><h3 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h3><p>阿里云服务器作为Server</p><ol><li><p>获取Frp</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;github.com&#x2F;fatedier&#x2F;frp&#x2F;releases&#x2F;download&#x2F;v0.32.1&#x2F;frp_0.32.1_linux_amd64.tar.gz
tar -zxvf  frp_0.32.1_linux_amd64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></li><li><p>编辑<code>frps.ini</code>文件<br>配置server和client通讯端口，这里设置为7000<br>配置frp控制面板，可以监控端口状态</p><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[common]</span>
<span class="token constant">bind_port</span> <span class="token attr-value"><span class="token punctuation">=</span> 7000</span>

<span class="token comment">#frp 控制面板</span>
<span class="token constant">dashboard_port</span> <span class="token attr-value"><span class="token punctuation">=</span> 7500</span>

<span class="token comment"># dashboard 用户名密码可选，默认都为 admin</span>
<span class="token constant">dashboard_user</span> <span class="token attr-value"><span class="token punctuation">=</span> admin</span>
<span class="token constant">dashboard_pwd</span> <span class="token attr-value"><span class="token punctuation">=</span> admin</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>配置服务自启动</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">vi &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;frps.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>内容为</p><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[Unit]</span>
<span class="token constant">Description</span><span class="token attr-value"><span class="token punctuation">=</span>frps</span>
<span class="token constant">After</span><span class="token attr-value"><span class="token punctuation">=</span>network.target</span>

<span class="token selector">[Service]</span>
<span class="token constant">ExecStart</span><span class="token attr-value"><span class="token punctuation">=</span>/root/frp_0.32.1_linux_amd64/frps -c /root/frp_0.32.1_linux_amd64/frps.ini </span>

<span class="token selector">[Install]</span>
<span class="token constant">WantedBy</span><span class="token attr-value"><span class="token punctuation">=</span>multi-user.target</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none"># 启动测试
systemctl start frps.service
# 查看启动状态
systemctl status frps.service
# 开机自启
systemctl enable frps.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>配置之后，需要在ECS控制台规则里放行通讯端口以及需要映射出去的端口。</p></li></ol><h3 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h3><p>在需要使用Frp的机器上进行配置</p><ol><li>下载Frp</li><li>编辑<code>frpc.ini</code><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token selector">[common]</span>
<span class="token constant">server_addr</span> <span class="token attr-value"><span class="token punctuation">=</span> X.X.X.X # 填自己服务器端的IP地址或者域名</span>
<span class="token constant">server_port</span> <span class="token attr-value"><span class="token punctuation">=</span> 7000 # 服务器端口，跟server端对应</span>

<span class="token selector">[ssh]</span>  #在一个server体系下，此处名称不能冲突
<span class="token constant">type</span> <span class="token attr-value"><span class="token punctuation">=</span> tcp</span>
<span class="token constant">local_ip</span> <span class="token attr-value"><span class="token punctuation">=</span> 127.0.0.1 </span>
<span class="token constant">local_port</span> <span class="token attr-value"><span class="token punctuation">=</span> 22</span>
<span class="token constant">remote_port</span> <span class="token attr-value"><span class="token punctuation">=</span> 6000 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li>windows下设置为系统服务，保证自启动<br>用winsw将frp注册为系统服务<br>下载：<a target="_blank" rel="noopener" href="https://github.com/kohsuke/winsw/releases">https://github.com/kohsuke/winsw/releases</a><br>改名为winsw.exe，放入frp目录<br>在此目录下，新建<code>utf8</code>编码的xml，命名<code>winsw.xml</code>,内容为<div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>frp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>frp这里是服务的名称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>这里是服务的介绍<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>frpc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arguments</span><span class="token punctuation">></span></span>-c frpc.ini<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arguments</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onfailure</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>restart<span class="token punctuation">"</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60 sec<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onfailure</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>restart<span class="token punctuation">"</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>120 sec<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logmode</span><span class="token punctuation">></span></span>reset<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logmode</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>在目录里cmd运行<div class="code-wrapper"><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">winsw install
winsw start

# winsw stop
# winsw uninstall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>在系统服务中就可以看到frp服务了</li></ol><h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>更多高级设置可参考<a target="_blank" rel="noopener" href="https://gofrp.org/docs/">文档</a>。其实主要就是在两端配置frps和frpc配置文件。</p><h1 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h1><p>折腾一路下来，最深刻的感受就是：遇事不决就重启。<br>kill-&gt;restart-&gt;reboot-&gt;🤡</p><p>家用平台折腾了一圈，发现虚拟化最好的解决方案：花钱让专业的人买专业的服务器给你弄💴💴💴</p><p>当然，自己折腾乐呵乐呵就行，要不容易上头👨‍🦲</p><h2 id="Acknowledgements"><a href="#Acknowledgements" class="headerlink" title="Acknowledgements"></a>Acknowledgements</h2><a href="https://gitee.com/hejiang" class="card-body hover-with-bg" target="_blank" rel="noopener"><div class="card-content"><div class="link-avatar my-auto"><img src="https://portrait.gitee.com/uploads/avatars/user/180/541417_hejiang_1579424599.png!avatar200" srcset="/img/loading.gif" lazyload alt="" onerror='this.onerror=null,this.srcset=null,this.src=""'></div><div class="link-text"><div class="link-title">hejiang</div><div class="link-intro"></div></div></div></a><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://phoenixnap.com/kb/install-kvm-centos">How to Install KVM on CentOS 8</a> <a href="#fnref:1" rev="footnote" class="footnote-backref">↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://www.tecmint.com/install-kvm-in-centos-8/">How to Install KVM on CentOS/RHEL 8</a> <a href="#fnref:2" rev="footnote" class="footnote-backref">↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://www.wanhebin.com/devops/kvm/893.html">KVM虚拟机迁移（冷迁移、热迁移）</a> <a href="#fnref:3" rev="footnote" class="footnote-backref">↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://blog.csdn.net/allway2/article/details/102940533">在virt-manager中使用CPU型号主机直通</a> <a href="#fnref:4" rev="footnote" class="footnote-backref">↩</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://www.icode9.com/content-4-960089.html">qemu+spice的QXL配置</a> <a href="#fnref:5" rev="footnote" class="footnote-backref">↩</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://computingforgeeks.com/install-webvirtcloud-kvm-management-on-centos/">Install WebVirtCloud KVM Management on CentOS 8 / Stream 8</a> <a href="#fnref:6" rev="footnote" class="footnote-backref">↩</a></span></span></li></ol></div></section></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/KVM/">KVM</a></div></div><p class="note note-info">本文最后更新于：2021年8月29日 凌晨</p><p class="note note-warning"><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://mattblog.oss-cn-beijing.aliyuncs.com/img/ico/cc.png" srcset="/img/loading.gif" lazyload></a>本作品采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2021/07/23/%E7%A9%BA%E9%97%B4%E5%88%86%E6%9E%90-%E5%9B%BD%E7%95%8C%E7%9C%81%E7%95%8C%E8%8E%B7%E5%8F%96/"><span class="hidden-mobile">空间分析-国界省界获取</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><script>Fluid.utils.lazyComments("comments",function(){var t="github-light",e="github-dark",i="dark"===(i=document.documentElement.getAttribute("data-user-color-scheme"))?e:t;window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","MattZou/mattzou.github.io"),e.setAttribute("issue-term","title"),e.setAttribute("label","utterances"),e.setAttribute("theme",i),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("02/26/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="🚀 &nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="https://mattblog.oss-cn-beijing.aliyuncs.com/js/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t){(0,Fluid.plugins.typing)(t.getElementById("subtitle").title)}((window,document))</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",function(){searchFunc("/local-search.xml","local-search-input","local-search-result")}),$("#modalSearch").on("shown.bs.modal",function(){$("#local-search-input").focus()})</script><script src="/js/boot.js"></script></body></html>